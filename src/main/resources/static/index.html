<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åƒåœ¾åˆ†ç±»åŠ©æ‰‹</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        html, body { overflow-x: hidden; max-width: 100%; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 100; display: none; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90vh; overflow-y: auto; z-index: 101; display: none; }
        @media (max-width: 768px) { .modal { width: 95%; } }
        .type-card { transition: all 0.3s ease; border-radius: 15px; overflow: hidden; }
        .type-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .recyclable { border-top: 5px solid #1890ff; }
        .kitchen { border-top: 5px solid #52c41a; }
        .hazardous { border-top: 5px solid #f5222d; }
        .other { border-top: 5px solid #8c8c8c; }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .file-upload-area { border: 3px dashed #cbd5e0; border-radius: 12px; transition: all 0.3s ease; }
        .file-upload-area:hover { border-color: #9f7aea; background-color: #faf5ff; }
        .file-upload-area.dragover { border-color: #9f7aea; background-color: #f5f3ff; transform: scale(1.02); }
        .user-menu { position: relative; }
        .user-menu-content { position: absolute; right: 0; top: 100%; min-width: 200px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; z-index: 50; }
        .user-menu:hover .user-menu-content { display: block; }
        .tab-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .category-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .category-recyclable { background-color: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }
        .category-kitchen { background-color: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .category-hazardous { background-color: #fff1f0; color: #f5222d; border: 1px solid #ffa39e; }
        .category-other { background-color: #fafafa; color: #8c8c8c; border: 1px solid #d9d9d9; }
        .category-unknown { background-color: #f8f0ff; color: #722ed1; border: 1px solid #d3adf7; }
        .progress-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }
        .result-item { border-left: 4px solid transparent; transition: all 0.2s ease; }
        .result-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="gradient-bg">
    <!-- æ¨¡æ€æ¡†éƒ¨åˆ†ä¿æŒä¸å˜ -->
    <div id="modalBackdrop" class="modal-backdrop" onclick="closeModal()"></div>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal glass-card p-8 max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">ç”¨æˆ·ç™»å½•</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="loginMessage" class="my-4"></div>
        
        <form onsubmit="login(event)">
            <div class="mb-4">
                <label for="loginStudentId" class="block text-gray-700 mb-2">å­¦å·</label>
                <input type="text" id="loginStudentId" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="è¯·è¾“å…¥å­¦å·" required>
            </div>
            
            <div class="mb-6">
                <label for="loginPassword" class="block text-gray-700 mb-2">å¯†ç </label>
                <input type="password" id="loginPassword" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="è¯·è¾“å…¥å¯†ç " required>
            </div>
            
            <button type="submit" 
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition font-semibold">
                <i class="fas fa-sign-in-alt mr-2"></i>ç™»å½•
            </button>
        </form>
        
        <div class="mt-6 text-center">
            <p class="text-gray-600">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ 
                <a href="#" onclick="showRegister()" class="text-purple-600 hover:text-purple-800 font-semibold">ç«‹å³æ³¨å†Œ</a>
            </p>
        </div>
    </div>
    
    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal glass-card p-8 max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">ç”¨æˆ·æ³¨å†Œ</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="registerMessage" class="my-4"></div>
        
        <form onsubmit="register(event)">
            <div class="mb-4">
                <label for="registerStudentId" class="block text-gray-700 mb-2">å­¦å·</label>
                <input type="text" id="registerStudentId" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="10-15ä½æ•°å­—" required>
            </div>
            
            <div class="mb-4">
                <label for="registerUsername" class="block text-gray-700 mb-2">ç”¨æˆ·å</label>
                <input type="text" id="registerUsername" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="2-20ä½å­—ç¬¦" required>
            </div>
            
            <div class="mb-4">
                <label for="registerPassword" class="block text-gray-700 mb-2">å¯†ç </label>
                <input type="password" id="registerPassword" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œ6-20ä½" required>
            </div>
            
            <div class="mb-4">
                <label for="registerEmail" class="block text-gray-700 mb-2">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                <input type="email" id="registerEmail" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="è¯·è¾“å…¥é‚®ç®±">
            </div>
            
            <div class="mb-4">
                <label for="registerPhone" class="block text-gray-700 mb-2">æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰</label>
                <input type="tel" id="registerPhone" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="11ä½æ‰‹æœºå·">
            </div>
            
            <div class="mb-6">
                <label for="registerDormitory" class="block text-gray-700 mb-2">å®¿èˆï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="registerDormitory" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="å¦‚ï¼šæ¢…å›­1æ ‹101">
            </div>
            
            <button type="submit" 
                    class="w-full py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition font-semibold">
                <i class="fas fa-user-plus mr-2"></i>æ³¨å†Œ
            </button>
        </form>
        
        <div class="mt-6 text-center">
            <p class="text-gray-600">å·²æœ‰è´¦æˆ·ï¼Ÿ 
                <a href="#" onclick="showLogin()" class="text-purple-600 hover:text-purple-800 font-semibold">ç«‹å³ç™»å½•</a>
            </p>
        </div>
    </div>


    
    <!-- ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="userInfoModal" class="modal glass-card p-8 max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">ä¸ªäººä¿¡æ¯</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <div class="flex justify-between">
                <span class="text-gray-600">ç”¨æˆ·åï¼š</span>
                <span id="userName" class="font-semibold text-gray-800">ç”¨æˆ·</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">å­¦å·ï¼š</span>
                <span id="userStudentId" class="font-semibold text-gray-800"></span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">å½“å‰ç§¯åˆ†ï¼š</span>
                <span id="userPoints" class="font-semibold text-green-600">0</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">ç”¨æˆ·ç­‰çº§ï¼š</span>
                <span id="userLevel" class="font-semibold text-purple-600">æ™®é€šç”¨æˆ·</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">é‚®ç®±ï¼š</span>
                <span id="userEmail" class="font-semibold text-gray-800">æœªè®¾ç½®</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">æ‰‹æœºå·ï¼š</span>
                <span id="userPhone" class="font-semibold text-gray-800">æœªè®¾ç½®</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">å®¿èˆï¼š</span>
                <span id="userDormitory" class="font-semibold text-gray-800">æœªè®¾ç½®</span>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <button onclick="logout()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
            </button>
        </div>
    </div>

</div>

<!-- ç§¯åˆ†å…‘æ¢å•†åŸæ¨¡æ€æ¡† -->
<!-- ç§¯åˆ†å…‘æ¢å•†åŸæ¨¡æ€æ¡† -->
<div id="pointsExchangeModal" class="modal glass-card p-8 max-w-4xl w-full">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-2xl font-bold text-gray-800">ç§¯åˆ†å…‘æ¢ä¸­å¿ƒ</h3>
            <p class="text-gray-600 mt-1">
                å½“å‰ç§¯åˆ†: <span id="exchangeCurrentPoints" class="font-bold text-green-600">0</span>
                <span class="text-sm text-gray-500 ml-3">ï¼ˆæ­£ç¡®åˆ†ç±»åƒåœ¾å¯è·å¾—ç§¯åˆ†ï¼‰</span>
            </p>
        </div>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div id="exchangeMessage" class="my-4"></div>
    
    <!-- æ ‡ç­¾é¡µå¯¼èˆª - ç®€åŒ–ä¸º2ä¸ª -->
    <div class="mb-6">
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg" style="max-width: 300px;">
            <button onclick="switchExchangeTab('all')" id="tabAll" class="flex-1 py-2 px-4 text-center rounded-lg font-medium tab-active">
                å…¨éƒ¨åˆ¸ç§
            </button>
            <button onclick="switchExchangeTab('records')" id="tabRecords" class="flex-1 py-2 px-4 text-center rounded-lg font-medium">
                å…‘æ¢è®°å½•
            </button>
        </div>
    </div>
    
    <!-- å•†å“åˆ—è¡¨åŒºåŸŸ -->
    <div id="exchangeItemsContainer" class="mb-8">
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500">æ­£åœ¨åŠ è½½å¯å…‘æ¢åˆ¸...</p>
        </div>
    </div>
    
    <!-- å…‘æ¢è®°å½•åŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="exchangeRecordsContainer" class="mb-8" style="display: none;">
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500">æ­£åœ¨åŠ è½½å…‘æ¢è®°å½•...</p>
        </div>
    </div>
    
    <!-- å…‘æ¢ç¡®è®¤å¼¹çª—ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
    <div id="exchangeConfirmModal" class="modal glass-card p-6 max-w-md w-full" style="display: none; position: relative;">
        <div class="flex justify-between items-center mb-4">
            <h4 class="text-xl font-bold text-gray-800">ç¡®è®¤å…‘æ¢</h4>
            <button onclick="closeExchangeConfirm()" class="text-gray-400 hover:text-gray-600 text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="exchangeConfirmInfo" class="mb-6">
            <!-- åŠ¨æ€å¡«å……ç¡®è®¤ä¿¡æ¯ -->
        </div>
        
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg mb-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-500 mt-1 mr-2"></i>
                <div>
                    <p class="text-sm text-yellow-800">
                        <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>å…‘æ¢æˆåŠŸåï¼Œå¯åœ¨å…‘æ¢è®°å½•ä¸­æŸ¥çœ‹ä¼˜æƒ åˆ¸ç 
                    </p>
                </div>
            </div>
        </div>
        
        <div class="flex space-x-3">
            <button onclick="confirmExchange()" 
                    class="flex-1 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition font-semibold">
                <i class="fas fa-check mr-2"></i>ç¡®è®¤å…‘æ¢
            </button>
            <button onclick="closeExchangeConfirm()" 
                    class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition font-semibold">
                å–æ¶ˆ
            </button>
        </div>
    </div>
</div>
    
    <!-- å›¾ç‰‡è¯†åˆ«æ¨¡æ€æ¡† -->
    <div id="imageRecognitionModal" class="modal glass-card p-8 max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">å›¾ç‰‡è¯†åˆ«</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="recognitionMessage" class="my-4"></div>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div id="uploadArea" class="mb-6">
            <div class="file-upload-area p-8 text-center cursor-pointer" 
                 onclick="document.getElementById('imageFile').click()"
                 ondrop="handleDrop(event)" 
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
                <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                <div class="mb-4">
                    <i class="fas fa-cloud-upload-alt text-4xl text-purple-400"></i>
                </div>
                <h4 class="text-lg font-semibold text-gray-700 mb-2">ä¸Šä¼ åƒåœ¾å›¾ç‰‡</h4>
                <p class="text-gray-500 mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p class="text-sm text-gray-400">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
            </div>
            
            <div id="imagePreview" class="mt-4" style="display: none;">
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-image text-purple-600"></i>
                        </div>
                        <div>
                            <p id="fileName" class="font-medium text-gray-800"></p>
                            <p id="fileSize" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <button onclick="removeImage()" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <img id="previewImage" class="max-h-48 mx-auto rounded-lg shadow-md">
                </div>
            </div>
        </div>
        
        <!-- è¯†åˆ«ç»“æœåŒºåŸŸ -->
        <div id="recognitionResult" style="display: none;">
            <div class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">æ€»ä½“ç½®ä¿¡åº¦</span>
                            <span id="overallConfidence" class="font-bold text-blue-600">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="confidenceBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">è¯†åˆ«ç‰©å“</span>
                            <span id="itemsCount" class="font-bold text-green-600">0ä¸ª</span>
                        </div>
                        <div class="text-sm text-gray-500 mt-1" id="categoriesCount">0ç±»</div>
                    </div>
                    
                    <div id="pointsEarned" class="bg-yellow-50 p-4 rounded-lg" style="display: none;">
                        <div class="flex items-center">
                            <i class="fas fa-coins text-yellow-500 mr-2"></i>
                            <div>
                                <p class="font-medium text-yellow-800">ç§¯åˆ†å¥–åŠ±</p>
                                <p id="pointsText" class="text-yellow-700">è·å¾— <span id="pointsValue">0</span> ç§¯åˆ†</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="suggestionBox" class="bg-green-50 border-l-4 border-green-400 p-4 rounded-lg mb-4">
                    <div class="flex items-start">
                        <i class="fas fa-lightbulb text-green-500 mt-1 mr-2"></i>
                        <div>
                            <p class="font-medium text-green-800 mb-1">æŠ•æ”¾å»ºè®®</p>
                            <p id="suggestionText" class="text-green-700">æ­£åœ¨åˆ†æ...</p>
                        </div>
                    </div>
                </div>
                
                <div id="hazardWarning" class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg mb-4" style="display: none;">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-2"></i>
                        <div>
                            <p class="font-medium text-red-800 mb-1">âš ï¸ é‡è¦æé†’</p>
                            <p id="hazardWarningText" class="text-red-700">æ£€æµ‹åˆ°æœ‰å®³åƒåœ¾ï¼Œè¯·åŠ¡å¿…å•ç‹¬å¤„ç†ï¼</p>
                        </div>
                    </div>
                </div>
                
                <h5 class="font-semibold text-gray-700 mb-3">è¯†åˆ«åˆ°çš„ç‰©å“</h5>
                <div id="itemsList" class="space-y-3 max-h-64 overflow-y-auto p-2"></div>
                
                <div id="categoryStats" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                    <!-- è¿™é‡Œä¼šåŠ¨æ€ç”Ÿæˆåˆ†ç±»ç»Ÿè®¡ -->
                </div>
            </div>
        </div>
        
        <div class="flex space-x-3">
            <button id="recognizeBtn" onclick="recognizeImage()" 
                    class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                <i class="fas fa-brain mr-2"></i>å¼€å§‹è¯†åˆ«
            </button>
            <button onclick="resetRecognition()" class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition font-semibold">
                é‡æ–°ä¸Šä¼ 
            </button>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-6">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-white/20 mr-4">
                    <i class="fas fa-recycle text-2xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">æ™ºèƒ½åƒåœ¾åˆ†ç±»åŠ©æ‰‹</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button onclick="showTestInfo()" class="px-4 py-2 bg-yellow-500 text-white rounded-xl hover:bg-yellow-600 transition shadow-md">
                    <i class="fas fa-vial mr-2"></i>æµ‹è¯•è´¦æˆ·
                </button>
                
                <div id="notLoggedIn" class="flex items-center space-x-3">
                    <button onclick="showLogin()" class="px-6 py-2 bg-white/20 backdrop-blur-sm text-white rounded-xl hover:bg-white/30 transition shadow-md">
                        ç™»å½•
                    </button>
                    <button onclick="showRegister()" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition shadow-md">
                        æ³¨å†Œ
                    </button>
                </div>
                
                <div id="loggedIn" class="user-menu" style="display: none;">
                    <div class="flex items-center space-x-3 cursor-pointer">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-400 to-purple-600 flex items-center justify-center text-white shadow-md">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <p id="navUsername" class="font-semibold text-white">ç”¨æˆ·å</p>
                            <p id="navPoints" class="text-xs text-white/80">ç§¯åˆ†: 0</p>
                        </div>
                        <i class="fas fa-chevron-down text-white/60"></i>
                    </div>
                    <div class="user-menu-content">
                        <div class="py-4 px-4">
                            <p class="font-semibold text-gray-800 mb-2" id="menuUsername">ç”¨æˆ·å</p>
                            <p class="text-sm text-gray-600 mb-4" id="menuStudentId">å­¦å·</p>
                            <div class="space-y-2">
                                <a href="#" onclick="showUserInfo()" class="block px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                                    <i class="fas fa-user-circle mr-2"></i>ä¸ªäººä¿¡æ¯
                                </a>
                                <a href="#" onclick="logout()" class="block px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="glass-card p-8 mb-8 text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">ğŸŒ± æ¬¢è¿ä½¿ç”¨æ™ºèƒ½åƒåœ¾åˆ†ç±»åŠ©æ‰‹</h2>
            <p class="text-gray-600 mb-6">é€šè¿‡AIæ™ºèƒ½è¯†åˆ«æŠ€æœ¯ï¼Œè½»æ¾è§£å†³åƒåœ¾åˆ†ç±»éš¾é¢˜</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                    <i class="fas fa-camera text-blue-500 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-800 mb-1">æ™ºèƒ½æ‹ç…§è¯†åˆ«</h4>
                    <p class="text-sm text-gray-600">ä¸Šä¼ åƒåœ¾å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«åˆ†ç±»</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
                    <i class="fas fa-award text-green-500 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-800 mb-1">ç§¯åˆ†å¥–åŠ±ç³»ç»Ÿ</h4>
                    <p class="text-sm text-gray-600">æ­£ç¡®åˆ†ç±»è·å–ç§¯åˆ†ï¼Œå…‘æ¢å¥–åŠ±</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition">
                    <i class="fas fa-graduation-cap text-purple-500 text-2xl mb-2"></i>
                    <h4 class="font-semibold text-gray-800 mb-1">åˆ†ç±»çŸ¥è¯†å­¦ä¹ </h4>
                    <p class="text-sm text-gray-600">å­¦ä¹ åƒåœ¾åˆ†ç±»çŸ¥è¯†ï¼Œæå‡ç¯ä¿æ„è¯†</p>
                </div>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg text-left mb-6">
                <p class="text-yellow-800">
                    <i class="fas fa-lightbulb mr-2"></i>
                    <strong>ä½¿ç”¨æç¤ºï¼š</strong> é¦–æ¬¡ä½¿ç”¨è¯·å…ˆæ³¨å†Œè´¦æˆ·ï¼Œæˆ–ä½¿ç”¨æµ‹è¯•è´¦æˆ·å¿«é€Ÿä½“éªŒ
                </p>
            </div>
        </div>

        <!-- ç™»å½•æç¤º -->
        <div id="loginRequired" class="glass-card p-8 mb-8 text-center">
            <div class="mb-6">
                <i class="fas fa-lock-open text-6xl text-purple-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">ç«‹å³ç™»å½•è§£é”å…¨éƒ¨åŠŸèƒ½</h3>
                <p class="text-gray-600 mb-4">ä½“éªŒæ™ºèƒ½è¯†åˆ«ã€ç§¯åˆ†å¥–åŠ±ã€åˆ†ç±»å­¦ä¹ ç­‰å®Œæ•´åŠŸèƒ½</p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="showLogin()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl hover:from-purple-700 hover:to-purple-800 transition shadow-lg hover:shadow-xl">
                    <i class="fas fa-sign-in-alt mr-2"></i>ç«‹å³ç™»å½•
                </button>
                <button onclick="showRegister()" class="px-8 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl hover:from-green-700 hover:to-green-800 transition shadow-lg hover:shadow-xl">
                    <i class="fas fa-user-plus mr-2"></i>å…è´¹æ³¨å†Œ
                </button>
            </div>
        </div>

        <!-- åŠŸèƒ½æ¼”ç¤ºåŒºåŸŸï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
        <div id="mainContent" style="display: none;">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white mb-3">âœ¨ æ¬¢è¿å›æ¥ï¼Œ<span id="welcomeUsername">ç”¨æˆ·</span>ï¼</h2>
                <p class="text-white/80 mb-6">å¼€å§‹æ‚¨çš„åƒåœ¾åˆ†ç±»ä¹‹æ—…å§ï¼</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 type-card hover:shadow-xl transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-camera text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">å¿«é€Ÿè¯†åˆ«</h3>
                            <p class="text-gray-600 mb-4">ä¸Šä¼ åƒåœ¾å›¾ç‰‡ï¼ŒAIæ™ºèƒ½è¯†åˆ«åˆ†ç±»</p>
                            <button onclick="showImageRecognition()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                å¼€å§‹è¯†åˆ«
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass-card p-6 type-card hover:shadow-xl transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-trophy text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">ç§¯åˆ†å¥–åŠ±</h3>
                            <p class="text-gray-600 mb-4">å½“å‰ç§¯åˆ†ï¼š<span class="font-bold text-green-600" id="mainPoints">0</span></p>
                            <p class="text-sm text-gray-500 mb-4">å¯ç”¨ç§¯åˆ†å…‘æ¢é£Ÿå ‚ã€è¶…å¸‚æ¶ˆè´¹åˆ¸</p>
                            <button onclick="showPointsExchange()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                                å…‘æ¢æ¶ˆè´¹åˆ¸
                            </button>
                        </div>
                    </div>
                    
                    
                        
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==== å…¨å±€é”™è¯¯å¤„ç†å’Œè°ƒè¯• ====
        window.addEventListener('error', function(e) {
            console.warn('æ•è·åˆ°JavaScripté”™è¯¯:', {
                æ¶ˆæ¯: e.message,
                æ–‡ä»¶: e.filename,
                è¡Œå·: e.lineno,
                åˆ—å·: e.colno
            });
        });

        // å®‰å…¨å…ƒç´ è®¿é—®è¾…åŠ©å‡½æ•°
        const getSafeElement = (id) => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`âš ï¸ å…ƒç´  #${id} ä¸å­˜åœ¨`);
                return null;
            }
            return element;
        };

        // ==== å½“å‰ç”¨æˆ·ä¿¡æ¯ ====
        let currentUser = null;
        let currentToken = null;
        let selectedFile = null;
        
        // ==== é¡µé¢åˆå§‹åŒ– ====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€');
            checkLoginStatus();
        });
        
        // ==== æµ‹è¯•è´¦æˆ·åŠŸèƒ½ ====
        function showTestInfo() {
            alert(`æµ‹è¯•è´¦æˆ·ä¿¡æ¯ï¼š
å­¦å·: 2024123456 (10ä½æ•°å­—)
å¯†ç : abc123 (åŒ…å«å­—æ¯å’Œæ•°å­—)

æˆ–è€…è‡ªè¡Œæ³¨å†Œè´¦æˆ·ï¼š
1. å­¦å·: 10-15ä½æ•°å­—
2. ç”¨æˆ·å: 2-20ä½
3. å¯†ç : åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œ6-20ä½
4. é‚®ç®±: å¯é€‰
5. æ‰‹æœºå·: å¯é€‰ï¼ˆ11ä½ï¼‰
6. å®¿èˆ: å¯é€‰`);
            
            // å®‰å…¨åœ°å¡«å……æµ‹è¯•è´¦æˆ·
            const loginStudentId = getSafeElement('loginStudentId');
            const loginPassword = getSafeElement('loginPassword');
            
            if (loginStudentId && loginPassword) {
                loginStudentId.value = '2024123456';
                loginPassword.value = 'abc123';
                showLogin();
            }
        }
        
        // ==== ç™»å½•çŠ¶æ€ç®¡ç† ====
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                try {
                    currentToken = token;
                    currentUser = JSON.parse(user);
                    updateUIForLoggedIn();
                } catch (e) {
                    console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                    logout();
                }
            } else {
                updateUIForNotLoggedIn();
            }
        }
        
        function updateUIForLoggedIn() {
            const notLoggedIn = getSafeElement('notLoggedIn');
            const loggedIn = getSafeElement('loggedIn');
            const loginRequired = getSafeElement('loginRequired');
            const mainContent = getSafeElement('mainContent');
            
            if (notLoggedIn) notLoggedIn.style.display = 'none';
            if (loggedIn) loggedIn.style.display = 'block';
            if (loginRequired) loginRequired.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            if (currentUser) {
                const navUsername = getSafeElement('navUsername');
                const navPoints = getSafeElement('navPoints');
                const menuUsername = getSafeElement('menuUsername');
                const menuStudentId = getSafeElement('menuStudentId');
                const welcomeUsername = getSafeElement('welcomeUsername');
                const mainPoints = getSafeElement('mainPoints');
                
                if (navUsername) navUsername.textContent = currentUser.username || 'ç”¨æˆ·';
                if (navPoints) navPoints.textContent = `ç§¯åˆ†: ${currentUser.totalPoints || 0}`;
                if (menuUsername) menuUsername.textContent = currentUser.username || 'ç”¨æˆ·';
                if (menuStudentId) menuStudentId.textContent = currentUser.studentId || '';
                if (welcomeUsername) welcomeUsername.textContent = currentUser.username || 'ç”¨æˆ·';
                if (mainPoints) mainPoints.textContent = currentUser.totalPoints || 0;
            }
        }
        
        function updateUIForNotLoggedIn() {
            const notLoggedIn = getSafeElement('notLoggedIn');
            const loggedIn = getSafeElement('loggedIn');
            const loginRequired = getSafeElement('loginRequired');
            const mainContent = getSafeElement('mainContent');
            
            if (notLoggedIn) notLoggedIn.style.display = 'flex';
            if (loggedIn) loggedIn.style.display = 'none';
            if (loginRequired) loginRequired.style.display = 'block';
            if (mainContent) mainContent.style.display = 'none';
            
            closeModal();
        }
        
        // ==== æ¨¡æ€æ¡†ç®¡ç† ====
        function showLogin() {
            const modalBackdrop = getSafeElement('modalBackdrop');
            const loginModal = getSafeElement('loginModal');
            const registerModal = getSafeElement('registerModal');
            const userInfoModal = getSafeElement('userInfoModal');
            const imageRecognitionModal = getSafeElement('imageRecognitionModal');
            const loginMessage = getSafeElement('loginMessage');
            
            if (modalBackdrop) modalBackdrop.style.display = 'block';
            if (loginModal) loginModal.style.display = 'block';
            if (registerModal) registerModal.style.display = 'none';
            if (userInfoModal) userInfoModal.style.display = 'none';
            if (imageRecognitionModal) imageRecognitionModal.style.display = 'none';
            if (loginMessage) loginMessage.innerHTML = '';
        }
        
        function showRegister() {
            const modalBackdrop = getSafeElement('modalBackdrop');
            const loginModal = getSafeElement('loginModal');
            const registerModal = getSafeElement('registerModal');
            const userInfoModal = getSafeElement('userInfoModal');
            const imageRecognitionModal = getSafeElement('imageRecognitionModal');
            const registerMessage = getSafeElement('registerMessage');
            
            if (modalBackdrop) modalBackdrop.style.display = 'block';
            if (loginModal) loginModal.style.display = 'none';
            if (registerModal) registerModal.style.display = 'block';
            if (userInfoModal) userInfoModal.style.display = 'none';
            if (imageRecognitionModal) imageRecognitionModal.style.display = 'none';
            if (registerMessage) registerMessage.innerHTML = '';
            
            // æ¸…ç©ºæ³¨å†Œè¡¨å•
            const registerFields = [
                'registerStudentId', 'registerUsername', 'registerPassword',
                'registerEmail', 'registerPhone', 'registerDormitory'
            ];
            
            registerFields.forEach(id => {
                const field = getSafeElement(id);
                if (field) field.value = '';
            });
        }
        
        function showUserInfo() {
            const modalBackdrop = getSafeElement('modalBackdrop');
            const loginModal = getSafeElement('loginModal');
            const registerModal = getSafeElement('registerModal');
            const userInfoModal = getSafeElement('userInfoModal');
            const imageRecognitionModal = getSafeElement('imageRecognitionModal');
            
            if (modalBackdrop) modalBackdrop.style.display = 'block';
            if (loginModal) loginModal.style.display = 'none';
            if (registerModal) registerModal.style.display = 'none';
            if (userInfoModal) userInfoModal.style.display = 'block';
            if (imageRecognitionModal) imageRecognitionModal.style.display = 'none';
            
            if (currentUser) {
                const userFields = [
                    {id: 'userName', value: currentUser.username || 'ç”¨æˆ·'},
                    {id: 'userStudentId', value: currentUser.studentId || ''},
                    {id: 'userPoints', value: currentUser.totalPoints || 0},
                    {id: 'userLevel', value: currentUser.levelName || 'æ™®é€šç”¨æˆ·'},
                    {id: 'userEmail', value: currentUser.email || 'æœªè®¾ç½®'},
                    {id: 'userPhone', value: currentUser.phone || 'æœªè®¾ç½®'},
                    {id: 'userDormitory', value: currentUser.dormitory || 'æœªè®¾ç½®'}
                ];
                
                userFields.forEach(field => {
                    const element = getSafeElement(field.id);
                    if (element) element.textContent = field.value;
                });
            }
        }
        
        function showImageRecognition() {
            const modalBackdrop = getSafeElement('modalBackdrop');
            const loginModal = getSafeElement('loginModal');
            const registerModal = getSafeElement('registerModal');
            const userInfoModal = getSafeElement('userInfoModal');
            const imageRecognitionModal = getSafeElement('imageRecognitionModal');
            
            if (modalBackdrop) modalBackdrop.style.display = 'block';
            if (loginModal) loginModal.style.display = 'none';
            if (registerModal) registerModal.style.display = 'none';
            if (userInfoModal) userInfoModal.style.display = 'none';
            if (imageRecognitionModal) imageRecognitionModal.style.display = 'block';
            
            resetRecognition();
        }
        
        function closeModal() {
    const elements = [
        'modalBackdrop', 'loginModal', 'registerModal',
        'userInfoModal', 'imageRecognitionModal', 'pointsExchangeModal'
    ];
    
    elements.forEach(id => {
        const element = getSafeElement(id);
        if (element) element.style.display = 'none';
    });
}
        
        // ==== ç”¨æˆ·è®¤è¯åŠŸèƒ½ ====
        async function login(event) {
            event.preventDefault();
            
            const studentId = getSafeElement('loginStudentId')?.value;
            const password = getSafeElement('loginPassword')?.value;
            
            if (!studentId || !password) {
                showMessage('loginMessage', 'è¯·å¡«å†™å­¦å·å’Œå¯†ç ', 'error');
                return;
            }
            
            const loginMessage = getSafeElement('loginMessage');
            if (!loginMessage) return;
            
            showLoading(loginMessage, 'æ­£åœ¨ç™»å½•ä¸­...');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({studentId: studentId, password: password})
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    const userData = result.data;
                    currentToken = userData.accessToken;
                    currentUser = userData;
                    
                    localStorage.setItem('token', currentToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    updateUIForLoggedIn();
                    closeModal();
                    showMessage('loginMessage', 'âœ… ç™»å½•æˆåŠŸï¼æ¬¢è¿ä½¿ç”¨æ™ºèƒ½åƒåœ¾åˆ†ç±»åŠ©æ‰‹', 'success');
                    
                    console.log('ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯:', currentUser);
                } else {
                    throw new Error(result.message || `ç™»å½•å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showMessage('loginMessage', `âŒ ${error.message}`, 'error');
            }
        }
        
        async function register(event) {
            event.preventDefault();
            
            const studentId = getSafeElement('registerStudentId')?.value;
            const username = getSafeElement('registerUsername')?.value;
            const password = getSafeElement('registerPassword')?.value;
            const email = getSafeElement('registerEmail')?.value;
            const phone = getSafeElement('registerPhone')?.value;
            const dormitory = getSafeElement('registerDormitory')?.value;
            
            if (!studentId || !/^\d{10,15}$/.test(studentId)) {
                showMessage('registerMessage', 'å­¦å·å¿…é¡»æ˜¯10-15ä½æ•°å­—', 'error');
                return;
            }
            
            if (!username || username.length < 2 || username.length > 20) {
                showMessage('registerMessage', 'ç”¨æˆ·åå¿…é¡»æ˜¯2-20ä½å­—ç¬¦', 'error');
                return;
            }
            
            if (!password || !/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*?&]{6,20}$/.test(password)) {
                showMessage('registerMessage', 'å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œé•¿åº¦6-20ä½', 'error');
                return;
            }
            
            const registerMessage = getSafeElement('registerMessage');
            if (!registerMessage) return;
            
            showLoading(registerMessage, 'æ­£åœ¨æ³¨å†Œä¸­...');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        studentId: studentId,
                        username: username,
                        password: password,
                        email: email || null,
                        phone: phone || null,
                        dormitory: dormitory || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 200) {
                    const userData = result.data;
                    currentToken = userData.accessToken;
                    currentUser = userData;
                    
                    localStorage.setItem('token', currentToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    updateUIForLoggedIn();
                    closeModal();
                    showMessage('registerMessage', 'âœ… æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•', 'success');
                } else {
                    throw new Error(result.message || `æ³¨å†Œå¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showMessage('registerMessage', `âŒ ${error.message}`, 'error');
            }
        }
        
        async function logout() {
            try {
                if (currentToken) {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
            } catch (error) {
                console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
            } finally {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;
                currentToken = null;
                updateUIForNotLoggedIn();
                closeModal();
            }
        }
        
        // ==== å›¾ç‰‡è¯†åˆ«åŠŸèƒ½ ====
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'copy';
            event.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            if (!file.type.match('image.*')) {
                showRecognitionMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showRecognitionMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                return;
            }
            
            selectedFile = file;
            
            const fileName = getSafeElement('fileName');
            const fileSize = getSafeElement('fileSize');
            const imagePreview = getSafeElement('imagePreview');
            const recognizeBtn = getSafeElement('recognizeBtn');
            
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = formatFileSize(file.size);
            if (imagePreview) imagePreview.style.display = 'block';
            if (recognizeBtn) recognizeBtn.disabled = false;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = getSafeElement('previewImage');
                if (previewImage) previewImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            const recognitionResult = getSafeElement('recognitionResult');
            if (recognitionResult) recognitionResult.style.display = 'none';
            
            showRecognitionMessage('å›¾ç‰‡å·²é€‰æ‹©ï¼Œç‚¹å‡»"å¼€å§‹è¯†åˆ«"æŒ‰é’®è¿›è¡Œåˆ†æ', 'info');
        }
        
        function removeImage() {
            selectedFile = null;
            const imageFile = getSafeElement('imageFile');
            if (imageFile) imageFile.value = '';
            
            const imagePreview = getSafeElement('imagePreview');
            if (imagePreview) imagePreview.style.display = 'none';
            
            const recognizeBtn = getSafeElement('recognizeBtn');
            if (recognizeBtn) recognizeBtn.disabled = true;
            
            const recognitionResult = getSafeElement('recognitionResult');
            if (recognitionResult) recognitionResult.style.display = 'none';
            
            showRecognitionMessage('', 'info');
        }
        
        function resetRecognition() {
            removeImage();
            const recognitionResult = getSafeElement('recognitionResult');
            if (recognitionResult) recognitionResult.style.display = 'none';
        }
        
        async function recognizeImage() {
            if (!selectedFile) {
                showRecognitionMessage('è¯·å…ˆé€‰æ‹©å›¾ç‰‡', 'error');
                return;
            }
            
            const messageDiv = getSafeElement('recognitionMessage');
            if (!messageDiv) return;
            
            showLoading(messageDiv, 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...');
            
            const recognizeBtn = getSafeElement('recognizeBtn');
            if (recognizeBtn) recognizeBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            try {
                console.log('å¼€å§‹å‘é€è¯†åˆ«è¯·æ±‚...');
                const response = await fetch('/api/garbage/recognize', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`è¯†åˆ«å¤±è´¥: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log('åŸå§‹å“åº”:', responseText);
                
                let result;
                
                try {
                    result = JSON.parse(responseText);
                    console.log('JSONè§£ææˆåŠŸ:', result);
                } catch (jsonError) {
                    console.warn('ç›´æ¥JSONè§£æå¤±è´¥:', jsonError);
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        try {
                            result = JSON.parse(jsonMatch[0]);
                        } catch (parseError) {
                            console.error('æå–çš„JSONè§£æå¤±è´¥:', parseError);
                            result = createMockResultFromText(responseText);
                        }
                    } else {
                        throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                }
                
                displayRecognitionResult(result);
                
            } catch (error) {
                console.error('è¯†åˆ«é”™è¯¯:', error);
                showRecognitionMessage(`âŒ ${error.message}`, 'error');
                const recognizeBtn = getSafeElement('recognizeBtn');
                if (recognizeBtn) recognizeBtn.disabled = false;
            }
        }
        
        function createMockResultFromText(text) {
            const result = {
                items: [],
                confidence: 0,
                suggestion: '',
                points: 0
            };
            
            const confidenceMatch = text.match(/ç½®ä¿¡åº¦:\s*([\d.]+)/);
            if (confidenceMatch) result.confidence = parseFloat(confidenceMatch[1]);
            
            const pointsMatch = text.match(/å¯è·å¾—\s*(\d+)\s*ç§¯åˆ†/);
            if (pointsMatch) result.points = parseInt(pointsMatch[1]);
            
            const suggestionMatch = text.match(/å»ºè®®[ï¼š:]\s*([^\n]+)/);
            if (suggestionMatch) result.suggestion = suggestionMatch[1].trim();
            
            const itemLines = text.split('\n').filter(line => line.includes('ç‰©å“:'));
            itemLines.forEach(line => {
                const itemMatch = line.match(/ç‰©å“:\s*([^,]+),\s*åˆ†ç±»:\s*([^,]+),\s*åˆ†æ•°:\s*([\d.]+)/);
                if (itemMatch) {
                    result.items.push({
                        name: itemMatch[1].trim(),
                        category: itemMatch[2].trim(),
                        score: parseFloat(itemMatch[3])
                    });
                }
            });
            
            return result;
        }
        
        function displayRecognitionResult(result) {
            console.log('æ˜¾ç¤ºè¯†åˆ«ç»“æœ:', result);
            
            const recognitionResult = getSafeElement('recognitionResult');
            if (recognitionResult) recognitionResult.style.display = 'block';
            
            // æ€»ä½“ç½®ä¿¡åº¦
            const confidence = result.confidence || 0;
            const confidencePercent = Math.round(confidence * 100);
            const overallConfidence = getSafeElement('overallConfidence');
            const confidenceBar = getSafeElement('confidenceBar');
            
            if (overallConfidence) overallConfidence.textContent = `${confidencePercent}%`;
            if (confidenceBar) confidenceBar.style.width = `${confidencePercent}%`;
            
            // æŠ•æ”¾å»ºè®®
            const suggestion = result.suggestion || 'è¯·æ ¹æ®è¯†åˆ«ç»“æœåˆ†ç±»æŠ•æ”¾';
            const suggestionText = getSafeElement('suggestionText');
            if (suggestionText) suggestionText.textContent = suggestion;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰å®³åƒåœ¾
            const hasHazardous = result.items && result.items.some(item => 
                item.category && item.category.includes('æœ‰å®³')
            );
            
            const hazardWarning = getSafeElement('hazardWarning');
            if (hazardWarning) {
                hazardWarning.style.display = hasHazardous ? 'block' : 'none';
            }
            
            // ç§¯åˆ†å¥–åŠ±
            const pointsEarned = getSafeElement('pointsEarned');
            const pointsValue = getSafeElement('pointsValue');
            if (pointsEarned && pointsValue) {
                if (result.points && result.points > 0) {
                    pointsEarned.style.display = 'block';
                    pointsValue.textContent = result.points;
                    
                    if (currentUser) {
                        currentUser.totalPoints = (currentUser.totalPoints || 0) + result.points;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        updateUIForLoggedIn();
                    }
                } else {
                    pointsEarned.style.display = 'none';
                }
            }
            
            // è¯†åˆ«åˆ°çš„ç‰©å“åˆ—è¡¨
            const itemsList = getSafeElement('itemsList');
            const itemsCount = getSafeElement('itemsCount');
            const categoriesCount = getSafeElement('categoriesCount');
            
            let itemsCountValue = 0;
            const categoryStats = {};
            const uniqueCategories = new Set();
            
            if (itemsList) itemsList.innerHTML = '';
            
            if (result.items && Array.isArray(result.items)) {
                itemsCountValue = result.items.length;
                result.items.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                result.items.forEach((item, index) => {
                    const category = item.category || 'æœªçŸ¥';
                    const name = item.name || 'æœªçŸ¥ç‰©å“';
                    const score = item.score || 0;
                    
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                    uniqueCategories.add(category);
                    
                    if (itemsList) {
                        const categoryClass = getCategoryClass(category);
                        const categoryName = getCategoryName(category);
                        const scorePercent = Math.round(score * 100);
                        const borderClass = getBorderClass(category);
                        
                        const itemElement = document.createElement('div');
                        itemElement.className = `result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 ${borderClass}`;
                        itemElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <h6 class="font-semibold text-gray-800 mr-2">${name}</h6>
                                        <span class="category-badge ${categoryClass}">${categoryName}</span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <span class="text-gray-500 mr-3">ç½®ä¿¡åº¦: ${scorePercent}%</span>
                                        <div class="flex-1 max-w-xs">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${scorePercent}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <span class="text-gray-400 text-sm">#${index + 1}</span>
                            </div>
                        `;
                        itemsList.appendChild(itemElement);
                    }
                });
            }
            
            if (itemsCount) itemsCount.textContent = `${itemsCountValue}ä¸ª`;
            if (categoriesCount) categoriesCount.textContent = `${uniqueCategories.size}ç±»`;
            
            // æ˜¾ç¤ºåˆ†ç±»ç»Ÿè®¡
            displayCategoryStats(categoryStats);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showRecognitionMessage('âœ… è¯†åˆ«å®Œæˆï¼æŸ¥çœ‹ä¸‹æ–¹è¯†åˆ«ç»“æœ', 'success');
            const recognizeBtn = getSafeElement('recognizeBtn');
            if (recognizeBtn) recognizeBtn.disabled = false;
        }
        
        function displayCategoryStats(categoryStats) {
            const statsContainer = getSafeElement('categoryStats');
            if (!statsContainer) return;
            
            statsContainer.innerHTML = '';
            
            const categories = [
                { id: 'å¯å›æ”¶ç‰©', name: 'å¯å›æ”¶ç‰©', color: 'blue', icon: 'recycle' },
                { id: 'å¨ä½™åƒåœ¾', name: 'å¨ä½™åƒåœ¾', color: 'green', icon: 'apple-alt' },
                { id: 'æœ‰å®³åƒåœ¾', name: 'æœ‰å®³åƒåœ¾', color: 'red', icon: 'radiation-alt' },
                { id: 'å…¶ä»–åƒåœ¾', name: 'å…¶ä»–åƒåœ¾', color: 'gray', icon: 'trash-alt' },
                { id: 'æœªçŸ¥', name: 'æœªçŸ¥', color: 'purple', icon: 'question-circle' }
            ];
            
            categories.forEach(category => {
                const count = categoryStats[category.id] || categoryStats[category.name] || 0;
                if (count > 0) {
                    const statElement = document.createElement('div');
                    statElement.className = `bg-${category.color}-50 p-3 rounded-lg text-center`;
                    statElement.innerHTML = `
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full bg-${category.color}-100 flex items-center justify-center mb-1">
                                <i class="fas fa-${category.icon} text-${category.color}-600"></i>
                            </div>
                            <span class="text-sm text-gray-600">${category.name}</span>
                            <span class="text-lg font-bold text-${category.color}-600">${count}</span>
                        </div>
                    `;
                    statsContainer.appendChild(statElement);
                }
            });
        }
        
        function getCategoryClass(category) {
            if (category.includes('å¯å›æ”¶')) return 'category-recyclable';
            if (category.includes('å¨ä½™')) return 'category-kitchen';
            if (category.includes('æœ‰å®³')) return 'category-hazardous';
            if (category.includes('å…¶ä»–')) return 'category-other';
            return 'category-unknown';
        }
        
        function getCategoryName(category) {
            return category || 'æœªçŸ¥';
        }
        
        function getBorderClass(category) {
            if (category.includes('å¯å›æ”¶')) return 'border-l-blue-500';
            if (category.includes('å¨ä½™')) return 'border-l-green-500';
            if (category.includes('æœ‰å®³')) return 'border-l-red-500';
            if (category.includes('å…¶ä»–')) return 'border-l-gray-500';
            return 'border-l-purple-500';
        }
        
        // ==== è¾…åŠ©å‡½æ•° ====
        function showMessage(elementId, message, type) {
            const element = getSafeElement(elementId);
            if (!element) {
                console.warn(`showMessage: å…ƒç´  #${elementId} ä¸å­˜åœ¨`);
                return;
            }
            
            const colorClass = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            element.innerHTML = `
                <div class="bg-${colorClass}-50 border-l-4 border-${colorClass}-500 p-3 rounded-lg">
                    <p class="text-${colorClass}-800">${message}</p>
                </div>
            `;
        }
        
        function showRecognitionMessage(message, type) {
            showMessage('recognitionMessage', message, type);
        }
        
        function showLoading(element, message) {
            let elementRef;
            if (typeof element === 'string') {
                elementRef = getSafeElement(element);
            } else {
                elementRef = element;
            }
            
            if (!elementRef) {
                console.warn('showLoading: å…ƒç´ ä¸å­˜åœ¨', element);
                return;
            }
            
            elementRef.innerHTML = `
                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                    <span>${message}</span>
                </div>
            `;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ==== å…¶ä»–åŠŸèƒ½ ====
        // ==== å…¶ä»–åŠŸèƒ½ ====
function showPointsExchange() {
    if (!currentUser) {
        alert('è¯·å…ˆç™»å½•');
        showLogin();
        return;
    }
    
    console.log('å½“å‰ç”¨æˆ·:', currentUser);
    console.log('å½“å‰Token:', currentToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
    console.log('Tokenå€¼:', currentToken);
    
    // å¦‚æœ token ä¸å­˜åœ¨ï¼Œå°è¯•ä» localStorage é‡æ–°è·å–
    if (!currentToken) {
        const savedToken = localStorage.getItem('token');
        if (savedToken) {
            currentToken = savedToken;
            console.log('ä» localStorage æ¢å¤ token');
        }
    }
    
    const modalBackdrop = getSafeElement('modalBackdrop');
    const pointsExchangeModal = getSafeElement('pointsExchangeModal');
    if (!modalBackdrop || !pointsExchangeModal) return;
    
    modalBackdrop.style.display = 'block';
    pointsExchangeModal.style.display = 'block';
    
    // éšè—å…¶ä»–æ¨¡æ€æ¡†
    ['loginModal', 'registerModal', 'userInfoModal', 'imageRecognitionModal'].forEach(id => {
        const element = getSafeElement(id);
        if (element) element.style.display = 'none';
    });
    
    // æ›´æ–°å½“å‰ç§¯åˆ†æ˜¾ç¤º
    const exchangeCurrentPoints = getSafeElement('exchangeCurrentPoints');
    if (exchangeCurrentPoints && currentUser) {
        exchangeCurrentPoints.textContent = currentUser.totalPoints || 0;
    }
    
    // åŠ è½½å•†å“åˆ—è¡¨
    loadExchangeItems();
}

// ========== ç§¯åˆ†å…‘æ¢ç›¸å…³å‡½æ•° ==========

let exchangeItemsData = [];
let currentExchangeTab = 'all';
let exchangeRecordsData = [];
let selectedItemForExchange = null;

// åŠ è½½å¯å…‘æ¢å•†å“
async function loadExchangeItems() {
    const exchangeItemsContainer = getSafeElement('exchangeItemsContainer');
    if (!exchangeItemsContainer) return;
    
    // æ·»åŠ  token éªŒè¯
    if (!currentToken) {
        console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½å•†å“');
        exchangeItemsContainer.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                <p class="text-red-600">è¯·å…ˆç™»å½•</p>
                <button onclick="showLogin()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ç«‹å³ç™»å½•
                </button>
            </div>
        `;
        return;
    }
    
    showLoading(exchangeItemsContainer, 'æ­£åœ¨åŠ è½½ä¼˜æƒ åˆ¸...');
    
    try {
        const response = await fetch('/api/points/exchange-items', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // å¦‚æœæ˜¯403ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
            if (response.status === 403) {
                console.warn('APIè®¿é—®å—é™ï¼Œæ˜¾ç¤ºæ¼”ç¤ºæ•°æ®');
                showMockExchangeItems();
                return;
            }
            throw new Error(`åŠ è½½å¤±è´¥: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.code === 200) {
            // å¤„ç†æ•°æ®
            exchangeItemsData = (result.data.items || result.data || []).map(item => ({
                itemId: item.itemId || item.id,
                name: item.name || 'æœªå‘½å',
                description: item.description || 'æ ¡å›­æ¶ˆè´¹åˆ¸',
                pointsRequired: item.pointsRequired || 0,
                stock: item.stock || 0,
                category: item.category || 'dining',
                validDays: item.validDays || 30,
                usageLocation: item.usageLocation || 'å…¨æ ¡é€šç”¨'
            }));
            
            renderExchangeItems();
        } else {
            throw new Error(result.message || 'åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½å•†å“é”™è¯¯:', error);
        // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
        showMockExchangeItems();
    }
}

// æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
function showMockExchangeItems() {
    exchangeItemsData = [
        {
            itemId: '1',
            name: 'é£Ÿå ‚2å…ƒæ¶ˆè´¹åˆ¸',
            description: 'å¯åœ¨é£Ÿå ‚ä»»æ„çª—å£ä½¿ç”¨',
            pointsRequired: 200,
            stock: 100,
            category: 'dining',
            validDays: 30,
            usageLocation: 'å­¦æ ¡é£Ÿå ‚'
        },
        {
            itemId: '2',
            name: 'æ—©é¤2å…ƒä»£é‡‘åˆ¸',
            description: 'é™æ—©é¤æ—¶æ®µä½¿ç”¨ï¼ˆ7:00-9:00ï¼‰',
            pointsRequired: 150,
            stock: 80,
            category: 'dining',
            validDays: 30,
            usageLocation: 'é£Ÿå ‚æ—©é¤çª—å£'
        },
        {
            itemId: '3',
            name: 'æ ¡å›­è¶…å¸‚9.5æŠ˜åˆ¸',
            description: 'æ ¡å›­è¶…å¸‚å…¨åœºé€šç”¨ï¼ˆçƒŸé…’é™¤å¤–ï¼‰',
            pointsRequired: 300,
            stock: 50,
            category: 'shop',
            validDays: 15,
            usageLocation: 'æ ¡å›­è¶…å¸‚'
        }
    ];
    
    renderExchangeItems();
    
    const exchangeItemsContainer = getSafeElement('exchangeItemsContainer');
    if (exchangeItemsContainer) {
        const warning = document.createElement('div');
        warning.className = 'bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mt-4';
        warning.innerHTML = `
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mt-1 mr-2"></i>
                <div>
                    <p class="text-sm text-blue-800">
                        <strong>æç¤ºï¼š</strong>æ­£ç¡®åˆ†ç±»åƒåœ¾å¯è·å¾—ç§¯åˆ†ï¼Œæ¯æ­£ç¡®åˆ†ç±»1æ¬¡å¯è·å¾—10-50ç§¯åˆ†
                    </p>
                </div>
            </div>
        `;
        exchangeItemsContainer.appendChild(warning);
    }
}

// æ¸²æŸ“å•†å“åˆ—è¡¨
function renderExchangeItems() {
    const exchangeItemsContainer = getSafeElement('exchangeItemsContainer');
    if (!exchangeItemsContainer) return;
    
    if (!exchangeItemsData || exchangeItemsData.length === 0) {
        exchangeItemsContainer.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-box-open text-gray-400 text-3xl mb-4"></i>
                <p class="text-gray-500">æš‚æ— ä¼˜æƒ åˆ¸</p>
                <p class="text-sm text-gray-400 mt-2">æ›´å¤šåˆ¸ç§å³å°†ä¸Šçº¿</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
    
    exchangeItemsData.forEach(item => {
        const isAvailable = item.stock > 0;
        const canAfford = currentUser && currentUser.totalPoints >= item.pointsRequired;
        const isDining = item.category === 'dining';
        
        html += `
            <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow border ${isDining ? 'border-green-100' : 'border-blue-100'}">
                <div class="p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-gray-800 mb-1">${item.name}</h4>
                            <p class="text-gray-600 text-sm mb-2">${item.description}</p>
                        </div>
                        <span class="${isDining ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} text-xs font-semibold px-3 py-1 rounded-full">
                            ${isDining ? 'é£Ÿå ‚åˆ¸' : 'è¶…å¸‚åˆ¸'}
                        </span>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center text-sm text-gray-600 mb-1">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span>é€‚ç”¨: ${item.usageLocation}</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="far fa-calendar-alt mr-2"></i>
                            <span>æœ‰æ•ˆæœŸ: ${item.validDays}å¤©</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">æ‰€éœ€ç§¯åˆ†</span>
                            <span class="text-xl font-bold text-red-600">${item.pointsRequired}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">å‰©ä½™åº“å­˜</span>
                            <span class="font-semibold ${item.stock > 10 ? 'text-green-600' : item.stock > 0 ? 'text-yellow-600' : 'text-red-600'}">
                                ${item.stock} å¼ 
                            </span>
                        </div>
                    </div>
                    
                    <button onclick="showExchangeConfirm('${item.itemId}')" 
                            class="w-full py-3 ${isAvailable && canAfford ? 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700' : 'bg-gray-300 cursor-not-allowed'} text-white rounded-lg font-semibold transition"
                            ${!isAvailable || !canAfford ? 'disabled' : ''}>
                        ${!isAvailable ? 'å·²å…‘å®Œ' : !canAfford ? 'ç§¯åˆ†ä¸è¶³' : 'ç«‹å³å…‘æ¢'}
                    </button>
                    
                    ${!canAfford && isAvailable ? `
                        <p class="text-center text-sm text-gray-500 mt-2">
                            è¿˜éœ€ ${item.pointsRequired - currentUser.totalPoints} ç§¯åˆ†
                        </p>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    exchangeItemsContainer.innerHTML = html;
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchExchangeTab(tab) {
    currentExchangeTab = tab;
    
    // æ›´æ–°æ ‡ç­¾æŒ‰é’®æ ·å¼
    const allTab = getSafeElement('tabAll');
    const recordsTab = getSafeElement('tabRecords');
    
    if (allTab) allTab.classList.toggle('tab-active', tab === 'all');
    if (recordsTab) recordsTab.classList.toggle('tab-active', tab === 'records');
    
    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
    const exchangeItemsContainer = getSafeElement('exchangeItemsContainer');
    const exchangeRecordsContainer = getSafeElement('exchangeRecordsContainer');
    
    if (tab === 'records') {
        if (exchangeItemsContainer) exchangeItemsContainer.style.display = 'none';
        if (exchangeRecordsContainer) {
            exchangeRecordsContainer.style.display = 'block';
            loadExchangeRecords();
        }
    } else {
        if (exchangeItemsContainer) exchangeItemsContainer.style.display = 'block';
        if (exchangeRecordsContainer) exchangeRecordsContainer.style.display = 'none';
        renderExchangeItems();
    }
}

// æ˜¾ç¤ºå…‘æ¢ç¡®è®¤å¼¹çª—
function showExchangeConfirm(itemId) {
    const item = exchangeItemsData.find(i => i.itemId === itemId);
    if (!item) return;
    
    selectedItemForExchange = item;
    
    const modalBackdrop = getSafeElement('modalBackdrop');
    const exchangeConfirmModal = getSafeElement('exchangeConfirmModal');
    
    if (modalBackdrop && exchangeConfirmModal) {
        modalBackdrop.style.display = 'block';
        exchangeConfirmModal.style.display = 'block';
        
        // æ˜¾ç¤ºç¡®è®¤ä¿¡æ¯
        const confirmInfo = getSafeElement('exchangeConfirmInfo');
        if (confirmInfo) {
            confirmInfo.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h5 class="font-bold text-lg mb-2">${item.name}</h5>
                    <p class="text-gray-600 mb-1">${item.description}</p>
                    <p class="text-gray-600 text-sm">é€‚ç”¨: ${item.usageLocation}</p>
                </div>
                
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-700">æ‰€éœ€ç§¯åˆ†:</span>
                        <span class="font-bold text-red-600">${item.pointsRequired}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-700">å½“å‰ç§¯åˆ†:</span>
                        <span class="font-bold text-green-600">${currentUser.totalPoints || 0}</span>
                    </div>
                    <div class="flex justify-between border-t pt-3">
                        <span class="text-gray-700">å…‘æ¢åå‰©ä½™:</span>
                        <span class="font-bold text-blue-600">${currentUser.totalPoints - item.pointsRequired}</span>
                    </div>
                </div>
            `;
        }
    }
}

// å…³é—­å…‘æ¢ç¡®è®¤å¼¹çª—
function closeExchangeConfirm() {
    const modalBackdrop = getSafeElement('modalBackdrop');
    const exchangeConfirmModal = getSafeElement('exchangeConfirmModal');
    
    if (modalBackdrop) modalBackdrop.style.display = 'none';
    if (exchangeConfirmModal) exchangeConfirmModal.style.display = 'none';
    selectedItemForExchange = null;
}

// ç¡®è®¤å…‘æ¢
async function confirmExchange() {
    if (!selectedItemForExchange) return;
    
    const item = selectedItemForExchange;
    const exchangeConfirmModal = getSafeElement('exchangeConfirmModal');
    
    if (!exchangeConfirmModal) return;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    exchangeConfirmModal.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">æ­£åœ¨å…‘æ¢ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/points/exchange', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                itemId: item.itemId,
                quantity: 1
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.code === 200) {
            // å…‘æ¢æˆåŠŸ
            exchangeConfirmModal.innerHTML = `
                <div class="text-center py-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mb-2">å…‘æ¢æˆåŠŸï¼</h4>
                    <p class="text-gray-600 mb-4">æˆåŠŸå…‘æ¢ ${item.name}</p>
                    ${result.data && result.data.couponCode ? `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-gray-600 mb-1">ä¼˜æƒ åˆ¸ç ï¼š</p>
                            <p class="text-lg font-bold text-green-700">${result.data.couponCode}</p>
                            <p class="text-xs text-gray-500 mt-1">å¯åœ¨å…‘æ¢è®°å½•ä¸­æŸ¥çœ‹</p>
                        </div>
                    ` : ''}
                    <button onclick="closeExchangeConfirmAndRefresh()" 
                            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ç¡®å®š
                    </button>
                </div>
            `;
            
            // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
            currentUser.totalPoints -= item.pointsRequired;
            localStorage.setItem('user', JSON.stringify(currentUser));
            
        } else {
            throw new Error(result.message || 'å…‘æ¢å¤±è´¥');
        }
    } catch (error) {
        console.error('å…‘æ¢é”™è¯¯:', error);
        
        exchangeConfirmModal.innerHTML = `
            <div class="text-center py-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-times text-red-600 text-2xl"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-800 mb-2">å…‘æ¢å¤±è´¥</h4>
                <p class="text-gray-600 mb-4">${error.message}</p>
                <div class="flex space-x-3">
                    <button onclick="confirmExchange()" 
                            class="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        é‡è¯•
                    </button>
                    <button onclick="closeExchangeConfirm()" 
                            class="flex-1 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        `;
    }
}

// å…³é—­ç¡®è®¤å¼¹çª—å¹¶åˆ·æ–°
function closeExchangeConfirmAndRefresh() {
    closeExchangeConfirm();
    
    // åˆ·æ–°é¡µé¢æ•°æ®
    loadExchangeItems();
    updateUIForLoggedIn();
    
    // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
    const exchangeCurrentPoints = getSafeElement('exchangeCurrentPoints');
    if (exchangeCurrentPoints && currentUser) {
        exchangeCurrentPoints.textContent = currentUser.totalPoints || 0;
    }
}

// åŠ è½½å…‘æ¢è®°å½•
async function loadExchangeRecords() {
    const exchangeRecordsContainer = getSafeElement('exchangeRecordsContainer');
    if (!exchangeRecordsContainer) return;
    
    showLoading(exchangeRecordsContainer, 'æ­£åœ¨åŠ è½½å…‘æ¢è®°å½•...');
    
    try {
        const response = await fetch('/api/points/exchange-records?page=0&size=20', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`åŠ è½½å¤±è´¥: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.code === 200) {
            exchangeRecordsData = result.data.content || result.data || [];
            renderExchangeRecords();
        } else {
            throw new Error(result.message || 'åŠ è½½è®°å½•å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è®°å½•é”™è¯¯:', error);
        showMockExchangeRecords();
    }
}

// æ˜¾ç¤ºæ¨¡æ‹Ÿå…‘æ¢è®°å½•
function showMockExchangeRecords() {
    exchangeRecordsData = [
        {
            itemName: 'é£Ÿå ‚2å…ƒæ¶ˆè´¹åˆ¸',
            exchangeTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
            pointsUsed: 200,
            status: 'å·²å®Œæˆ',
            couponCode: 'ST20241234001',
            validUntil: new Date(Date.now() + 29 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            itemName: 'æ—©é¤2å…ƒä»£é‡‘åˆ¸',
            exchangeTime: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            pointsUsed: 150,
            status: 'å·²å®Œæˆ',
            couponCode: 'ZC20241234002',
            validUntil: new Date(Date.now() + 27 * 24 * 60 * 60 * 1000).toISOString()
        }
    ];
    
    renderExchangeRecords();
}

// æ¸²æŸ“å…‘æ¢è®°å½•
function renderExchangeRecords() {
    const exchangeRecordsContainer = getSafeElement('exchangeRecordsContainer');
    if (!exchangeRecordsContainer) return;
    
    if (!exchangeRecordsData || exchangeRecordsData.length === 0) {
        exchangeRecordsContainer.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-history text-gray-400 text-3xl mb-4"></i>
                <p class="text-gray-500">æš‚æ— å…‘æ¢è®°å½•</p>
                <p class="text-sm text-gray-400 mt-2">å¿«å»å…‘æ¢ä¼˜æƒ åˆ¸å§ï¼</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="space-y-4">';
    
    exchangeRecordsData.forEach(record => {
        const statusColor = record.status === 'å·²å®Œæˆ' ? 'green' : 
                          record.status === 'å¤„ç†ä¸­' ? 'blue' : 'gray';
        
        const date = new Date(record.exchangeTime).toLocaleString('zh-CN');
        const validDate = record.validUntil ? new Date(record.validUntil).toLocaleDateString('zh-CN') : '';
        
        html += `
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h5 class="font-semibold text-gray-800">${record.itemName}</h5>
                        <p class="text-sm text-gray-500">å…‘æ¢æ—¶é—´: ${date}</p>
                    </div>
                    <span class="bg-${statusColor}-100 text-${statusColor}-800 text-xs font-semibold px-3 py-1 rounded-full">
                        ${record.status}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                    <div class="text-gray-600">æ¶ˆè€—ç§¯åˆ†:</div>
                    <div class="text-red-600 font-semibold">${record.pointsUsed}</div>
                    
                    ${record.couponCode ? `
                        <div class="text-gray-600">åˆ¸ç :</div>
                        <div class="font-mono text-green-700 bg-green-50 px-3 py-2 rounded border border-green-200">
                            ${record.couponCode}
                        </div>
                    ` : ''}
                </div>
                
                ${validDate ? `
                    <div class="flex items-center text-xs text-gray-500 border-t pt-3 mt-2">
                        <i class="far fa-calendar-check mr-2"></i>
                        <span>æœ‰æ•ˆæœŸè‡³: ${validDate}</span>
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    html += '</div>';
    
    exchangeRecordsContainer.innerHTML = html;
}

// æ˜¾ç¤ºå…‘æ¢è®°å½•ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
function showExchangeRecords() {
    switchExchangeTab('records');
}

    </script>
</body>
</html>